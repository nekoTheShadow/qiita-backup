[{"body":"@derickhino さん\n\nコメントありがとうございます。問題が解決したようで何よりです。それと同時に不正確なサンプルコードで戸惑わせてしまい、申し訳ありませんでした…。\n","created_at":"2017-10-24T22:45:32+09:00","id":"173c40f0334149b1018c","rendered_body":"<p><a href=\"/derickhino\" class=\"user-mention js-hovercard\" title=\"derickhino\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"derickhino\">@derickhino</a> さん</p>\n\n<p>コメントありがとうございます。問題が解決したようで何よりです。それと同時に不正確なサンプルコードで戸惑わせてしまい、申し訳ありませんでした…。</p>\n","updated_at":"2017-10-24T22:45:32+09:00","user":{"description":"IT業界の片隅でひっそり生きるシステムエンジニアです(´・ω・｀)","facebook_id":"","followees_count":0,"followers_count":36,"github_login_name":null,"id":"neko_the_shadow","items_count":199,"linkedin_id":"","location":"神奈川県川崎市","name":"","organization":"","permanent_id":105859,"profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/105859/profile-images/1473709753","team_only":false,"twitter_screen_name":"neko_the_shadow","website_url":"https://nekotheshadow.github.io/"}},{"body":"@scivola さん、 @neko_the_shadow さん、\n\nご回答ありがとうございます。\nご教授頂いたCSV.parse(file)にてエラーを回避することが出来ました。\n\nCSV.openの内部で行われているFile.openにinvalidやundefのオプションを渡すことが出来れば\nよりスマートに処理出来るのではと思ったのですが、現状ではそのような方法は用意されて無さそうですね。。。\n","created_at":"2017-10-24T17:08:15+09:00","id":"e4e012590cde7a026639","rendered_body":"<p><a href=\"/scivola\" class=\"user-mention js-hovercard\" title=\"scivola\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"scivola\">@scivola</a> さん、 <a href=\"/neko_the_shadow\" class=\"user-mention js-hovercard\" title=\"neko_the_shadow\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"neko_the_shadow\">@neko_the_shadow</a> さん、</p>\n\n<p>ご回答ありがとうございます。<br>\nご教授頂いたCSV.parse(file)にてエラーを回避することが出来ました。</p>\n\n<p>CSV.openの内部で行われているFile.openにinvalidやundefのオプションを渡すことが出来れば<br>\nよりスマートに処理出来るのではと思ったのですが、現状ではそのような方法は用意されて無さそうですね。。。</p>\n","updated_at":"2017-10-24T17:08:15+09:00","user":{"description":null,"facebook_id":null,"followees_count":0,"followers_count":0,"github_login_name":"derickhino","id":"derickhino","items_count":0,"linkedin_id":null,"location":null,"name":"","organization":null,"permanent_id":208985,"profile_image_url":"https://avatars1.githubusercontent.com/u/24762248?v=4","team_only":false,"twitter_screen_name":null,"website_url":null}},{"body":"@derickhino さん\n\nコメントありがとうございます。この記事を書いたのが少し前のため、「検証環境」が残っていません……。申し訳ありません。\n\n@scivola さんからの指摘をうけて、ライブラリのコードを確認したところ、`CSV#open`や`CSV#foreach`では内部的に`File#open`を呼び出しているようです。そこで以下のように`CSV#parse`を利用するか、あるいはコンストラクタ経由でcsvオブジェクトを生成して、検証してもらえないでしょうか? \n\n```rb\n# ex.1 CSV#parseを利用する\nFile.open(\"sample.csv\", :encoding => Encoding::CP932, :invalid => :replace, :undef => :replace) do |file|\n    CSV.parse(file) do |row|\n        do_something(row)\n    end\nend\n\n# ex.2 CSV#newを利用する\nFile.open(\"sample.csv\", :encoding => Encoding::CP932, :invalid => :replace, :undef => :replace) do |file|\n    csv = CSV.new(file)\n    csv.each do |row|\n        do_something(row)\n    end\nend\n```\n","created_at":"2017-10-23T23:20:36+09:00","id":"132ab07978954383a193","rendered_body":"<p><a href=\"/derickhino\" class=\"user-mention js-hovercard\" title=\"derickhino\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"derickhino\">@derickhino</a> さん</p>\n\n<p>コメントありがとうございます。この記事を書いたのが少し前のため、「検証環境」が残っていません……。申し訳ありません。</p>\n\n<p><a href=\"/scivola\" class=\"user-mention js-hovercard\" title=\"scivola\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"scivola\">@scivola</a> さんからの指摘をうけて、ライブラリのコードを確認したところ、<code>CSV#open</code>や<code>CSV#foreach</code>では内部的に<code>File#open</code>を呼び出しているようです。そこで以下のように<code>CSV#parse</code>を利用するか、あるいはコンストラクタ経由でcsvオブジェクトを生成して、検証してもらえないでしょうか? </p>\n\n<div class=\"code-frame\" data-lang=\"rb\"><div class=\"highlight\"><pre><code><span class=\"c1\"># ex.1 CSV#parseを利用する</span>\n<span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">open</span><span class=\"p\">(</span><span class=\"s2\">\"sample.csv\"</span><span class=\"p\">,</span> <span class=\"ss\">:encoding</span> <span class=\"o\">=&gt;</span> <span class=\"no\">Encoding</span><span class=\"o\">::</span><span class=\"no\">CP932</span><span class=\"p\">,</span> <span class=\"ss\">:invalid</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">,</span> <span class=\"ss\">:undef</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">file</span><span class=\"o\">|</span>\n    <span class=\"no\">CSV</span><span class=\"p\">.</span><span class=\"nf\">parse</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">row</span><span class=\"o\">|</span>\n        <span class=\"n\">do_something</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"c1\"># ex.2 CSV#newを利用する</span>\n<span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">open</span><span class=\"p\">(</span><span class=\"s2\">\"sample.csv\"</span><span class=\"p\">,</span> <span class=\"ss\">:encoding</span> <span class=\"o\">=&gt;</span> <span class=\"no\">Encoding</span><span class=\"o\">::</span><span class=\"no\">CP932</span><span class=\"p\">,</span> <span class=\"ss\">:invalid</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">,</span> <span class=\"ss\">:undef</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">file</span><span class=\"o\">|</span>\n    <span class=\"n\">csv</span> <span class=\"o\">=</span> <span class=\"no\">CSV</span><span class=\"p\">.</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">)</span>\n    <span class=\"n\">csv</span><span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">row</span><span class=\"o\">|</span>\n        <span class=\"n\">do_something</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div></div>\n","updated_at":"2017-10-23T23:20:36+09:00","user":{"description":"IT業界の片隅でひっそり生きるシステムエンジニアです(´・ω・｀)","facebook_id":"","followees_count":0,"followers_count":36,"github_login_name":null,"id":"neko_the_shadow","items_count":199,"linkedin_id":"","location":"神奈川県川崎市","name":"","organization":"","permanent_id":105859,"profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/105859/profile-images/1473709753","team_only":false,"twitter_screen_name":"neko_the_shadow","website_url":"https://nekotheshadow.github.io/"}},{"body":"@derickhino さん\n\n`File.open` でファイルを開いているのはいいのですが，`CSV.open` で改めてファイルを開こうとし，その際に `encoding` が指定されていない，というのが `InvalidByteSequenceError` の原因ではないでしょうか。\n\nやりたかったことは\n\n```rb\nrequire \"csv\"\nFile.open(\"sample.csv\", \"r\", :encoding => Encoding::CP932, :invalid => :replace, :undef => :replace) do |file|\n    CSV.parse(file.read) do |row|\n        do_something(row)\n    end\nend\n```\n\nでは。\n","created_at":"2017-10-23T20:44:02+09:00","id":"11d229439e21b30e6b88","rendered_body":"<p><a href=\"/derickhino\" class=\"user-mention js-hovercard\" title=\"derickhino\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"derickhino\">@derickhino</a> さん</p>\n\n<p><code>File.open</code> でファイルを開いているのはいいのですが，<code>CSV.open</code> で改めてファイルを開こうとし，その際に <code>encoding</code> が指定されていない，というのが <code>InvalidByteSequenceError</code> の原因ではないでしょうか。</p>\n\n<p>やりたかったことは</p>\n\n<div class=\"code-frame\" data-lang=\"rb\"><div class=\"highlight\"><pre><code><span class=\"nb\">require</span> <span class=\"s2\">\"csv\"</span>\n<span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">open</span><span class=\"p\">(</span><span class=\"s2\">\"sample.csv\"</span><span class=\"p\">,</span> <span class=\"s2\">\"r\"</span><span class=\"p\">,</span> <span class=\"ss\">:encoding</span> <span class=\"o\">=&gt;</span> <span class=\"no\">Encoding</span><span class=\"o\">::</span><span class=\"no\">CP932</span><span class=\"p\">,</span> <span class=\"ss\">:invalid</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">,</span> <span class=\"ss\">:undef</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">file</span><span class=\"o\">|</span>\n    <span class=\"no\">CSV</span><span class=\"p\">.</span><span class=\"nf\">parse</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">.</span><span class=\"nf\">read</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">row</span><span class=\"o\">|</span>\n        <span class=\"n\">do_something</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div></div>\n\n<p>では。</p>\n","updated_at":"2017-10-23T20:44:02+09:00","user":{"description":"主に Ruby を使ってます。Rust に興味を持っています。校閲承ります。私信は Slack の ruby-jp からどうぞ。","facebook_id":"","followees_count":0,"followers_count":527,"github_login_name":"scivola","id":"scivola","items_count":200,"linkedin_id":"","location":"","name":"","organization":"","permanent_id":48101,"profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/48101/profile-images/1473691230","team_only":false,"twitter_screen_name":null,"website_url":""}},{"body":"CSVのインポート時にEncoding::InvalidByteSequenceErrorが発生しこちらの記事を参考にさせて頂きました。\n\n```\nrequire \"csv\"\nFile.open(\"sample.csv\", \"r\", :encoding => Encoding::CP932, :invalid => :replace, :undef => :replace) do |file|\n    CSV.open(file) do |csv|\n        csv.each do |row|\n            do_something(row)\n        end\n    end\nend\n```\n\nこちらrails consoleにて試してみたのですが、\n`ArgumentError: invalid byte sequence in UTF-8`が発生してしまいます。\n\n私の環境だけの問題でしょうか。。。\n\nruby 2.3.4\nRails 5.0.1\n\nを利用しております。同じ環境で確認したいので、検証環境を教えて頂けないでしょうか？\n","created_at":"2017-10-23T18:44:26+09:00","id":"93def91f3eb738492e82","rendered_body":"<p>CSVのインポート時にEncoding::InvalidByteSequenceErrorが発生しこちらの記事を参考にさせて頂きました。</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre><code>require \"csv\"\nFile.open(\"sample.csv\", \"r\", :encoding =&gt; Encoding::CP932, :invalid =&gt; :replace, :undef =&gt; :replace) do |file|\n    CSV.open(file) do |csv|\n        csv.each do |row|\n            do_something(row)\n        end\n    end\nend\n</code></pre></div></div>\n\n<p>こちらrails consoleにて試してみたのですが、<br>\n<code>ArgumentError: invalid byte sequence in UTF-8</code>が発生してしまいます。</p>\n\n<p>私の環境だけの問題でしょうか。。。</p>\n\n<p>ruby 2.3.4<br>\nRails 5.0.1</p>\n\n<p>を利用しております。同じ環境で確認したいので、検証環境を教えて頂けないでしょうか？</p>\n","updated_at":"2017-10-23T18:44:26+09:00","user":{"description":null,"facebook_id":null,"followees_count":0,"followers_count":0,"github_login_name":"derickhino","id":"derickhino","items_count":0,"linkedin_id":null,"location":null,"name":"","organization":null,"permanent_id":208985,"profile_image_url":"https://avatars1.githubusercontent.com/u/24762248?v=4","team_only":false,"twitter_screen_name":null,"website_url":null}},{"body":"```rb\nFile.open(\"sample.rb\", \"r\", :encoding => Encoding::CP932, :invalid => :replace, :undef => :replace) do |file|\n    file.each_line do |line|\n        do_something(line)\n    end\nend\n```\n\nは\n\n```rb\nIO.foreach(\"sample.rb\", :encoding => Encoding::CP932, :invalid => :replace, :undef => :replace) do |line|\n  do_something(line)\nend\n```\n\nでいけると思います。\n\n入出力系のメソッドって，共通オプションが多くて（内部で使い回してて）ややこしいですね。\n","created_at":"2017-08-11T05:57:30+09:00","id":"758bf2b4865b7177c5c8","rendered_body":"<div class=\"code-frame\" data-lang=\"rb\"><div class=\"highlight\"><pre><code><span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">open</span><span class=\"p\">(</span><span class=\"s2\">\"sample.rb\"</span><span class=\"p\">,</span> <span class=\"s2\">\"r\"</span><span class=\"p\">,</span> <span class=\"ss\">:encoding</span> <span class=\"o\">=&gt;</span> <span class=\"no\">Encoding</span><span class=\"o\">::</span><span class=\"no\">CP932</span><span class=\"p\">,</span> <span class=\"ss\">:invalid</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">,</span> <span class=\"ss\">:undef</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">file</span><span class=\"o\">|</span>\n    <span class=\"n\">file</span><span class=\"p\">.</span><span class=\"nf\">each_line</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">line</span><span class=\"o\">|</span>\n        <span class=\"n\">do_something</span><span class=\"p\">(</span><span class=\"n\">line</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div></div>\n\n<p>は</p>\n\n<div class=\"code-frame\" data-lang=\"rb\"><div class=\"highlight\"><pre><code><span class=\"no\">IO</span><span class=\"p\">.</span><span class=\"nf\">foreach</span><span class=\"p\">(</span><span class=\"s2\">\"sample.rb\"</span><span class=\"p\">,</span> <span class=\"ss\">:encoding</span> <span class=\"o\">=&gt;</span> <span class=\"no\">Encoding</span><span class=\"o\">::</span><span class=\"no\">CP932</span><span class=\"p\">,</span> <span class=\"ss\">:invalid</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">,</span> <span class=\"ss\">:undef</span> <span class=\"o\">=&gt;</span> <span class=\"ss\">:replace</span><span class=\"p\">)</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">line</span><span class=\"o\">|</span>\n  <span class=\"n\">do_something</span><span class=\"p\">(</span><span class=\"n\">line</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div></div>\n\n<p>でいけると思います。</p>\n\n<p>入出力系のメソッドって，共通オプションが多くて（内部で使い回してて）ややこしいですね。</p>\n","updated_at":"2017-08-11T05:57:30+09:00","user":{"description":"主に Ruby を使ってます。Rust に興味を持っています。校閲承ります。私信は Slack の ruby-jp からどうぞ。","facebook_id":"","followees_count":0,"followers_count":527,"github_login_name":"scivola","id":"scivola","items_count":200,"linkedin_id":"","location":"","name":"","organization":"","permanent_id":48101,"profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/48101/profile-images/1473691230","team_only":false,"twitter_screen_name":null,"website_url":""}}]