{"rendered_body":"<p>仕事中に調べたメモを簡単にまとめなおしたものです。そのため時間をかけて調べてまとめあげたという質のものではありません。<strong>要するに自分用のメモです。</strong>その手の性質のメモをQiitaに挙げるべきかどうか悩んだのですが、DB2のLOADコマンドについてドキュメントが少ないのも事実。ちょっとしたとっかかりになればうれしいです(´・ω・｀)</p>\n\n<h1>\n<span id=\"基本文法\" class=\"fragment\"></span><a href=\"#%E5%9F%BA%E6%9C%AC%E6%96%87%E6%B3%95\"><i class=\"fa fa-link\"></i></a>基本文法</h1>\n\n<div class=\"code-frame\" data-lang=\"sql\"><div class=\"highlight\"><pre><code><span class=\"k\">load</span> <span class=\"k\">from</span> <span class=\"n\">xxxxx</span><span class=\"p\">.</span><span class=\"n\">csv</span> <span class=\"k\">of</span> <span class=\"n\">del</span>\n<span class=\"n\">modified</span> <span class=\"k\">by</span> <span class=\"n\">codepage</span><span class=\"o\">=</span><span class=\"mi\">1208</span>\n<span class=\"k\">replace</span> <span class=\"k\">into</span> <span class=\"n\">xxxxx_table</span>\n</code></pre></div></div>\n\n<p><strong>「とあるcsvファイル(文字コードはUTF-8)を特定のテーブルに読み込ませたい」</strong>という個人的によく遭遇する場面を実現するのが上記のサンプルです。なおLOADには多様なオプションや機能があるので、それを利用する場合には次のリンクを利用するのがよいでしょう: <a href=\"https://www.ibm.com/support/knowledgecenter/ja/SSEPEK_10.0.0/ugref/src/tpc/db2z_loadsyntax.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://www.ibm.com/support/knowledgecenter/ja/SSEPEK_10.0.0/ugref/src/tpc/db2z_loadsyntax.html</a></p>\n\n<h1>\n<span id=\"loadの進捗を監視したい\" class=\"fragment\"></span><a href=\"#load%E3%81%AE%E9%80%B2%E6%8D%97%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>LOADの進捗を監視したい</h1>\n\n<p>LOADコマンドはログを残さないという特質上、大量のデータをテーブルに投入する際利用されることが多いと思います。そこで気にかかるのが進捗具合。LOADコマンドがきわめて高速だとはいえ、数百万件数千万件単位のデータを投入するとなると時間がかかり、「いつ終わるのか」「途中で失敗していないか」「いったいどのぐらい進んでいるのか」ということが気になります――よね?</p>\n\n<div class=\"code-frame\" data-lang=\"sql\"><div class=\"highlight\"><pre><code><span class=\"n\">list</span> <span class=\"n\">utilities</span> <span class=\"k\">show</span> <span class=\"n\">detail</span>\n</code></pre></div></div>\n\n<p>LOADの進捗状況は<code>list utilities</code>により確認することができます。またリアルタイムで監視したいというような場合にはシェルスクリプトと組み合わせることも可能です。</p>\n\n<div class=\"code-frame\" data-lang=\"bash\"><div class=\"highlight\"><pre><code><span class=\"c\"># 5秒ごとにLOADの進捗状況を確認したい。</span>\n<span class=\"k\">while </span><span class=\"nb\">true</span><span class=\"p\">;</span> <span class=\"k\">do\n    </span>db2 <span class=\"s2\">\"list utilities show detail\"</span>\n    <span class=\"nb\">sleep </span>5 \n<span class=\"k\">done</span>\n</code></pre></div></div>\n\n<h1>\n<span id=\"load-pendingの確認と解消方法\" class=\"fragment\"></span><a href=\"#load-pending%E3%81%AE%E7%A2%BA%E8%AA%8D%E3%81%A8%E8%A7%A3%E6%B6%88%E6%96%B9%E6%B3%95\"><i class=\"fa fa-link\"></i></a>LOAD Pendingの確認と解消方法</h1>\n\n<p>参考: <a href=\"http://www-01.ibm.com/support/docview.wss?uid=swg21575037\" rel=\"nofollow noopener\" target=\"_blank\">[DB2 LUW] ロード・ペンディングの回復方法</a></p>\n\n<p>LOADを実行したテーブルに対して操作を行うと、<a href=\"https://www.ibm.com/support/knowledgecenter/ja/SSEPGG_9.7.0/com.ibm.db2.luw.messages.sql.doc/doc/msql00668n.html\" rel=\"nofollow noopener\" target=\"_blank\">SQLエラー「SQL0668N」</a>が返却され、操作に失敗することがあります。これはそのテーブルがPending状態にある、<strong>要するにLOADコマンド中にエラーがあり、テーブルが事実上ロックされてしまっている</strong>ということを示します。</p>\n\n<p>まずはこの確認方法ですが、次のようなコマンドをたたくことによりPending状態かどうかを確認することができます。個人的な体感ですが、このコマンドを実行して結果が返るまで時間がかかるので、実行した場合は気長に待ちましょう。</p>\n\n<div class=\"code-frame\" data-lang=\"SQL\"><div class=\"highlight\"><pre><code><span class=\"k\">select</span> \n    <span class=\"n\">tabschema</span><span class=\"p\">,</span>\n    <span class=\"n\">tabname</span><span class=\"p\">,</span> \n    <span class=\"n\">load_status</span><span class=\"p\">,</span> \n    <span class=\"n\">no_load_restart</span> \n<span class=\"k\">from</span> <span class=\"n\">sysibmadm</span><span class=\"p\">.</span><span class=\"n\">admintabinfo</span> \n<span class=\"k\">where</span> <span class=\"n\">load_status</span> <span class=\"o\">&lt;&gt;</span> <span class=\"s1\">'NULL'</span>\n</code></pre></div></div>\n\n<p>上記のコマンドの結果により、対象のテーブルがPendingにあることが分かった場合はLOADコマンドのterminateオプションを利用して、これを解消します。</p>\n\n<div class=\"code-frame\" data-lang=\"SQL\"><div class=\"highlight\"><pre><code><span class=\"k\">load</span> <span class=\"k\">from</span> <span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">del</span> <span class=\"k\">of</span> <span class=\"n\">del</span> \n<span class=\"n\">messages</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">txt</span> \n<span class=\"k\">terminate</span> <span class=\"k\">into</span> <span class=\"n\">xxxxx</span>\n</code></pre></div></div>\n\n<p>このとき<code>xxxxx</code>はPending状態にあるテーブルを示します。また<strong>from句に指定するファイル名(サンプルでは<code>test.del</code>)は何を指定しても構いません。</strong>Pendingの原因になったLOADコマンド実行時に指定したファイル名を指定する必要はなく、そもそも実在しないようなファイルを指定しても正常に動作します。</p>\n\n<h1>\n<span id=\"20170719-追記\" class=\"fragment\"></span><a href=\"#20170719-%E8%BF%BD%E8%A8%98\"><i class=\"fa fa-link\"></i></a>2017/07/19 追記:</h1>\n\n<p>この記事にはいくつかサンプルコードが提示されていますが、以下はそのサンプルをそれぞれ1行にまとめたものになります。なぜそのようなまとめを作っておくかというと――<strong>コピペしやすいから(´・ω・｀)</strong></p>\n\n<p>Qiitaの記事は見知らぬ他にに向けて発信するのが本来ですが、この記事に関しては筆者本人がお仕事中に参照することが多く、しかもそのような場合には<strong>「サンプルコードをコピペして、ターミナルに直接貼り付けたい」</strong>ということがほとんど。要するに自分の需要を満たしたいということです。</p>\n\n<div class=\"code-frame\" data-lang=\"sql\"><div class=\"highlight\"><pre><code><span class=\"k\">load</span> <span class=\"k\">from</span> <span class=\"n\">xxxxx</span><span class=\"p\">.</span><span class=\"n\">csv</span> <span class=\"k\">of</span> <span class=\"n\">del</span> <span class=\"n\">modified</span> <span class=\"k\">by</span> <span class=\"n\">codepage</span><span class=\"o\">=</span><span class=\"mi\">1208</span> <span class=\"k\">replace</span> <span class=\"k\">into</span> <span class=\"n\">xxxxx_table</span>\n</code></pre></div></div>\n\n<div class=\"code-frame\" data-lang=\"bash\"><div class=\"highlight\"><pre><code><span class=\"k\">while </span><span class=\"nb\">true</span><span class=\"p\">;</span> <span class=\"k\">do </span>db2 <span class=\"s2\">\"list utilities show detail\"</span><span class=\"p\">;</span>  <span class=\"nb\">sleep </span>5 <span class=\"p\">;</span> <span class=\"k\">done</span>\n</code></pre></div></div>\n\n<div class=\"code-frame\" data-lang=\"sql\"><div class=\"highlight\"><pre><code><span class=\"k\">select</span> <span class=\"n\">tabschema</span><span class=\"p\">,</span> <span class=\"n\">tabname</span><span class=\"p\">,</span>  <span class=\"n\">load_status</span><span class=\"p\">,</span>  <span class=\"n\">no_load_restart</span> <span class=\"k\">from</span> <span class=\"n\">sysibmadm</span><span class=\"p\">.</span><span class=\"n\">admintabinfo</span> <span class=\"k\">where</span> <span class=\"n\">load_status</span> <span class=\"o\">&lt;&gt;</span> <span class=\"s1\">'NULL'</span>\n</code></pre></div></div>\n\n<div class=\"code-frame\" data-lang=\"sql\"><div class=\"highlight\"><pre><code><span class=\"k\">load</span> <span class=\"k\">from</span> <span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">del</span> <span class=\"k\">of</span> <span class=\"n\">del</span> <span class=\"n\">messages</span> <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">txt</span>  <span class=\"k\">terminate</span> <span class=\"k\">into</span> <span class=\"n\">xxxxx</span>\n</code></pre></div></div>\n","body":"\n仕事中に調べたメモを簡単にまとめなおしたものです。そのため時間をかけて調べてまとめあげたという質のものではありません。__要するに自分用のメモです。__その手の性質のメモをQiitaに挙げるべきかどうか悩んだのですが、DB2のLOADコマンドについてドキュメントが少ないのも事実。ちょっとしたとっかかりになればうれしいです(´・ω・｀)\n\n# 基本文法\n\n```sql\nload from xxxxx.csv of del\nmodified by codepage=1208\nreplace into xxxxx_table\n```\n\n__「とあるcsvファイル(文字コードはUTF-8)を特定のテーブルに読み込ませたい」__という個人的によく遭遇する場面を実現するのが上記のサンプルです。なおLOADには多様なオプションや機能があるので、それを利用する場合には次のリンクを利用するのがよいでしょう: https://www.ibm.com/support/knowledgecenter/ja/SSEPEK_10.0.0/ugref/src/tpc/db2z_loadsyntax.html\n\n# LOADの進捗を監視したい\n\nLOADコマンドはログを残さないという特質上、大量のデータをテーブルに投入する際利用されることが多いと思います。そこで気にかかるのが進捗具合。LOADコマンドがきわめて高速だとはいえ、数百万件数千万件単位のデータを投入するとなると時間がかかり、「いつ終わるのか」「途中で失敗していないか」「いったいどのぐらい進んでいるのか」ということが気になります――よね?\n\n```sql\nlist utilities show detail\n```\n\nLOADの進捗状況は`list utilities`により確認することができます。またリアルタイムで監視したいというような場合にはシェルスクリプトと組み合わせることも可能です。\n\n```bash\n# 5秒ごとにLOADの進捗状況を確認したい。\nwhile true; do\n    db2 \"list utilities show detail\"\n    sleep 5 \ndone\n```\n\n# LOAD Pendingの確認と解消方法\n\n参考: [[DB2 LUW] ロード・ペンディングの回復方法](http://www-01.ibm.com/support/docview.wss?uid=swg21575037)\n\nLOADを実行したテーブルに対して操作を行うと、[SQLエラー「SQL0668N」](https://www.ibm.com/support/knowledgecenter/ja/SSEPGG_9.7.0/com.ibm.db2.luw.messages.sql.doc/doc/msql00668n.html)が返却され、操作に失敗することがあります。これはそのテーブルがPending状態にある、__要するにLOADコマンド中にエラーがあり、テーブルが事実上ロックされてしまっている__ということを示します。\n\nまずはこの確認方法ですが、次のようなコマンドをたたくことによりPending状態かどうかを確認することができます。個人的な体感ですが、このコマンドを実行して結果が返るまで時間がかかるので、実行した場合は気長に待ちましょう。\n\n```SQL\nselect \n    tabschema,\n    tabname, \n    load_status, \n    no_load_restart \nfrom sysibmadm.admintabinfo \nwhere load_status <> 'NULL'\n```\n\n上記のコマンドの結果により、対象のテーブルがPendingにあることが分かった場合はLOADコマンドのterminateオプションを利用して、これを解消します。\n\n```SQL\nload from test.del of del \nmessages msg.txt \nterminate into xxxxx\n```\n\nこのとき`xxxxx`はPending状態にあるテーブルを示します。また__from句に指定するファイル名(サンプルでは`test.del`)は何を指定しても構いません。__Pendingの原因になったLOADコマンド実行時に指定したファイル名を指定する必要はなく、そもそも実在しないようなファイルを指定しても正常に動作します。\n\n# 2017/07/19 追記:\n\nこの記事にはいくつかサンプルコードが提示されていますが、以下はそのサンプルをそれぞれ1行にまとめたものになります。なぜそのようなまとめを作っておくかというと――__コピペしやすいから(´・ω・｀)__\n\nQiitaの記事は見知らぬ他にに向けて発信するのが本来ですが、この記事に関しては筆者本人がお仕事中に参照することが多く、しかもそのような場合には__「サンプルコードをコピペして、ターミナルに直接貼り付けたい」__ということがほとんど。要するに自分の需要を満たしたいということです。\n\n```sql\nload from xxxxx.csv of del modified by codepage=1208 replace into xxxxx_table\n```\n\n```bash\nwhile true; do db2 \"list utilities show detail\";  sleep 5 ; done\n```\n\n```sql\nselect tabschema, tabname,  load_status,  no_load_restart from sysibmadm.admintabinfo where load_status <> 'NULL'\n```\n```sql\nload from test.del of del messages msg.txt  terminate into xxxxx\n```\n\n\n\n","coediting":false,"comments_count":0,"created_at":"2017-04-23T17:20:30+09:00","group":null,"id":"6e6ac5b258793981fa38","likes_count":4,"private":false,"reactions_count":0,"tags":[{"name":"SQL","versions":[]},{"name":"db2","versions":[]}],"title":"[DB2] Loadコマンドに関する自分用メモ(基本文法・進捗状況・Pending)","updated_at":"2017-07-19T22:11:24+09:00","url":"https://qiita.com/neko_the_shadow/items/6e6ac5b258793981fa38","user":{"description":"IT業界の片隅でひっそり生きるシステムエンジニアです(´・ω・｀)","facebook_id":"","followees_count":0,"followers_count":36,"github_login_name":null,"id":"neko_the_shadow","items_count":198,"linkedin_id":"","location":"神奈川県川崎市","name":"","organization":"","permanent_id":105859,"profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/105859/profile-images/1473709753","team_only":false,"twitter_screen_name":"neko_the_shadow","website_url":"https://nekotheshadow.github.io/"},"page_views_count":null,"team_membership":null}