<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Open状態のファイルに対して、Linuxだとos.Renameに成功するが、Windowsだとエラーになる - Qiita Backup</title><meta name=description content="環境情報 この記事は以下の環境で稼働確認を実施しました。 Windows Microsoft Windows [Version 10.0.19041.84] go version go1.13.5 windows/amd64 Linux Ubuntu 18.04 LTS (Bionic Beaver) go version go1.13.8 linux/amd64 事象 Open状態のファイルに対して、os.Ren"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Qiita Backup","url":"https:\/\/nekotheshadow.github.io\/qiita-backup"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/nekotheshadow.github.io\/qiita-backup"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/nekotheshadow.github.io\/qiita-backup","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/nekotheshadow.github.io\/qiita-backup\/blog\/2bef3358d82cbcea0512\/","name":"Open状態のファイルに対して、 linuxだとos. renameに成功するが、 windowsだとエラーになる"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"Open状態のファイルに対して、Linuxだとos.Renameに成功するが、Windowsだとエラーになる","description":"環境情報 この記事は以下の環境で稼働確認を実施しました。 Windows Microsoft Windows [Version 10.0.19041.84] go version go1.13.5 windows\/amd64 Linux Ubuntu 18.04 LTS (Bionic Beaver) go version go1.13.8 linux\/amd64 事象 Open状態のファイルに対して、os.Ren","inLanguage":"en","wordCount":1452,"datePublished":"2020-03-01T15:25:33","dateModified":"2020-03-01T15:25:33","image":"https:\/\/nekotheshadow.github.io\/qiita-backup","keywords":["Go"],"mainEntityOfPage":"https:\/\/nekotheshadow.github.io\/qiita-backup\/blog\/2bef3358d82cbcea0512\/","publisher":{"@type":"Organization","name":"https:\/\/nekotheshadow.github.io\/qiita-backup","logo":{"@type":"ImageObject","url":"https:\/\/nekotheshadow.github.io\/qiita-backup","height":60,"width":60}}}</script><meta property="og:title" content="Open状態のファイルに対して、Linuxだとos.Renameに成功するが、Windowsだとエラーになる"><meta property="og:description" content="環境情報 この記事は以下の環境で稼働確認を実施しました。 Windows Microsoft Windows [Version 10.0.19041.84] go version go1.13.5 windows/amd64 Linux Ubuntu 18.04 LTS (Bionic Beaver) go version go1.13.8 linux/amd64 事象 Open状態のファイルに対して、os.Ren"><meta property="og:url" content="https://nekotheshadow.github.io/qiita-backup/blog/2bef3358d82cbcea0512/"><meta property="og:type" content="website"><meta property="og:site_name" content="Qiita Backup"><meta name=twitter:title content="Open状態のファイルに対して、Linuxだとos.Renameに成功するが、Windowsだとエラーになる"><meta name=twitter:description content="環境情報 この記事は以下の環境で稼働確認を実施しました。 Windows Microsoft Windows [Version 10.0.19041.84] go version go1.13.5 windows/amd64 Linux Ubuntu 18.04 LTS (Bionic Beaver) go version go1.13.8 linux/amd64 事象 Open状態のファイルに対 …"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.118.2"><link rel=alternate href=https://nekotheshadow.github.io/qiita-backup/index.xml type=application/rss+xml title="Qiita Backup"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://nekotheshadow.github.io/qiita-backup/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://nekotheshadow.github.io/qiita-backup/css/syntax.css><link rel=stylesheet href=https://nekotheshadow.github.io/qiita-backup/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://nekotheshadow.github.io/qiita-backup>Qiita Backup</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=blog-heading><h1>Open状態のファイルに対して、Linuxだとos.Renameに成功するが、Windowsだとエラーになる</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h1 id=環境情報>環境情報</h1><p>この記事は以下の環境で稼働確認を実施しました。</p><ul><li>Windows<ul><li>Microsoft Windows [Version 10.0.19041.84]</li><li>go version go1.13.5 windows/amd64</li></ul></li><li>Linux<ul><li>Ubuntu 18.04 LTS (Bionic Beaver)</li><li>go version go1.13.8 linux/amd64</li></ul></li></ul><h1 id=事象>事象</h1><p>Open状態のファイルに対して、<code>os.Rename</code>を呼び出すと、LinuxとWindowsでは結果が異なります。具体的にはLinuxでは<code>os.Rename</code>に成功しますが、Windowsではエラーになります。</p><p>以下はOpen状態のファイルに対して、<code>os.Rename</code>を利用するコマンドです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go:main.go data-lang=go:main.go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;old.txt&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fp</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Rename</span>(<span style=color:#e6db74>&#34;old.txt&#34;</span>, <span style=color:#e6db74>&#34;new.txt&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>これをLinux(Ubuntu)環境でこのコードを実行すると、<code>os.Rename</code>が想定通り動作することが分かります。</p><pre tabindex=0><code>$ ls -ltr
total 0
-rwxrwxrwx 1 developer developer 214 Feb 23 22:01 main.go
-rwxrwxrwx 1 developer developer   0 Feb 23 22:05 old.txt
$ go run main.go
$ ls -ltr
total 0
-rwxrwxrwx 1 developer developer 214 Feb 23 22:01 main.go
-rwxrwxrwx 1 developer developer   0 Feb 23 22:05 new.txt
</code></pre><p>一方、Windows環境でこのプログラムを実行すると、panicが発生しました。</p><pre tabindex=0><code>C:\qiita&gt;go run main.go
panic: rename old.txt new.txt: The process cannot access the file because it is being used by another process.

goroutine 1 [running]:
main.main()
        C:/qiita/main.go:14 +0x131
exit status 2
</code></pre><h1 id=原因>原因</h1><h2 id=linux>Linux</h2><p>Linuxの場合、<code>os.Rename</code>の実体は<code>renameat</code>になります。これは以下のように<code>strace</code>を利用すすことで確かめることができます。</p><pre tabindex=0><code>$ go build -o main
$ strace -o strace.log ./main
</code></pre><p><code>renameat</code>は相対パスでファイル名の変更を行うAPIで、その<code>man</code>ページを見ると以下の通りに記述されており、<strong>Open状態のファイルでも名称変更ができることがわかります。</strong>_</p><blockquote><p>Open file descriptors for oldpath are also unaffected.</p></blockquote><h2 id=windows>Windows</h2><p><a href=https://ascii.jp/elem/000/001/423/1423022/>「Goならわかるシステムプログラミング 第10回 - ファイルシステムと、その上のGo言語の関数たち（1）」</a> によると、Windowsでの<code>os.Rename</code>の実体は<code>MoveFileEx</code>というWin32 apiとのことです。<a href=https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-movefileexa><code>MoveFileEx</code>のドキュメント</a>を見たところ、このAPIは対象ファイルの削除権限を要するとのことでした。</p><blockquote><p>To delete or rename a file, you must have either delete permission on the file or delete child permission in the parent directory.</p></blockquote><p>ここでGo言語本体のソースコードを見たところ、ファイルのオープンには<code>CreateFile</code>というWin32 APIを利用しているようです。<code>CreateFile</code>は開いたファイルの共有状態を指定するのですが、Go言語では<code>FILE_SHARE_DELETE</code>を指定していません (該当のソースコードは<a href=https://github.com/golang/go/blob/master/src/syscall/syscall_windows.go#L316>このあたり</a>)</p><p><strong>つまり削除権限なしの状態でオープンされているファイルに対して、削除権限を要するリネーム処理を行っているわけで、エラーになるのは当然といえます。</strong></p><h1 id=対策>対策</h1><p>作成したプログラムがさまざまなプラットフォーム・OSで利用されることが分かっている場合は、<code>os.Rename</code>の前には必ずファイルを閉じておくことが大事です。</p><h1 id=余談1>余談1</h1><p><code>CreateFile</code>を呼び出す際に<code>FILE_SHARE_DELETE</code>を付与して、WindowsでもLinuxと同じ挙動になるようにしてほしいという要望は実際あるようです(該当のIssueは<a href=https://github.com/golang/go/issues/32088>これ</a>)。ただ<a href=https://mattn.kaoriya.net/software/lang/go/20170817113831.htm>この記事</a>を読むと、単に<code>FILE_SHARE_DELETE</code>を付与すればよいだけでもないらしく、なかなか難しい問題をはらんでいることがが分かります。</p><h1 id=余談2>余談2</h1><p>とあるライブラリを利用しているときに、ドキュメントの記述と実際の挙動が一致しなかったことが、今回の問題に行き着いた個人的なきっかけになります。ちなみにそのライブラリのコードは次のようになっていました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>fp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;old.txt&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>DoSomething</span>(<span style=color:#a6e22e>fp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Rename</span>(<span style=color:#e6db74>&#34;old.txt&#34;</span>, <span style=color:#e6db74>&#34;new.txt&#34;</span>)
</span></span></code></pre></div><p>Windowsでは<code>os.Rename</code>がエラーを返すのですが、そのエラーをハンドリングせずに捨てており、結果として奇妙な動作になっていたのでした。<strong>APIが返してくるエラーを無視しないというのも大事な教訓ですね。</strong></p><div class=blog-tags><a href=https://nekotheshadow.github.io/qiita-backup/tags/go/>Go</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://nekotheshadow.github.io/qiita-backup/blog/49fdc992d2d3c5af03d2/ data-toggle=tooltip data-placement=top title="flagパッケージを利用しているときに、オプションの値をスライスで受け取りたい / 同じオプションを複数回指定し、その値をすべてスライスに詰めたい">&larr; Previous Post</a></li><li class=next><a href=https://nekotheshadow.github.io/qiita-backup/blog/e5ac4adffaa928332e78/ data-toggle=tooltip data-placement=top title=NSQ環境をDockerで構築する(『Go言語によるWebアプリケーション開発』第5章)>Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2023
&nbsp;&bull;&nbsp;
<a href=https://nekotheshadow.github.io/qiita-backup>Qiita Backup</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.118.2</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://nekotheshadow.github.io/qiita-backup/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://nekotheshadow.github.io/qiita-backup/js/load-photoswipe.js></script></body></html>