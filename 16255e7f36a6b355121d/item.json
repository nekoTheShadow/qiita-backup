{"rendered_body":"<p>前提として、Hibernateのversionは5.3.3。pom.xmlのdependenciesは次のようになります。</p>\n\n<div class=\"code-frame\" data-lang=\"xml\">\n<div class=\"code-lang\"><span class=\"bold\">pom.xml</span></div>\n<div class=\"highlight\"><pre><span class=\"c\">&lt;!-- https://mvnrepository.com/artifact/org.hibernate/hibernate-core --&gt;</span>\n<span class=\"nt\">&lt;dependency&gt;</span>\n  <span class=\"nt\">&lt;groupId&gt;</span>org.hibernate<span class=\"nt\">&lt;/groupId&gt;</span>\n  <span class=\"nt\">&lt;artifactId&gt;</span>hibernate-core<span class=\"nt\">&lt;/artifactId&gt;</span>\n  <span class=\"nt\">&lt;version&gt;</span>5.3.3.Final<span class=\"nt\">&lt;/version&gt;</span>\n<span class=\"nt\">&lt;/dependency&gt;</span>\n<span class=\"c\">&lt;!-- https://mvnrepository.com/artifact/javax.xml.bind/jaxb-api --&gt;</span>\n<span class=\"nt\">&lt;dependency&gt;</span>\n  <span class=\"nt\">&lt;groupId&gt;</span>javax.xml.bind<span class=\"nt\">&lt;/groupId&gt;</span>\n  <span class=\"nt\">&lt;artifactId&gt;</span>jaxb-api<span class=\"nt\">&lt;/artifactId&gt;</span>\n  <span class=\"nt\">&lt;version&gt;</span>2.3.0<span class=\"nt\">&lt;/version&gt;</span>\n<span class=\"nt\">&lt;/dependency&gt;</span>\n</pre></div>\n</div>\n\n<p>まず以下のような<code>META-INF\\persistence.xml</code>を準備します。dialectやdriverがDb2になっていますが、ここではRDBMSの種類は問題ではなく、たとえばMySQLやPostgresを選択しても同様の問題が発生する--はず。</p>\n\n<div class=\"code-frame\" data-lang=\"xml\">\n<div class=\"code-lang\"><span class=\"bold\">persistence.xml</span></div>\n<div class=\"highlight\"><pre><span class=\"cp\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span>\n\n<span class=\"nt\">&lt;persistence</span>\n  <span class=\"na\">xmlns=</span><span class=\"s\">\"http://xmlns.jcp.org/xml/ns/persistence\"</span>\n  <span class=\"na\">xmlns:xsi=</span><span class=\"s\">\"http://www.w3.org/2001/XMLSchema-instance\"</span>\n  <span class=\"na\">xsi:schemaLocation=</span><span class=\"s\">\"http://xmlns.jcp.org/xml/ns/persistence\n                      http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd\"</span>\n  <span class=\"na\">version=</span><span class=\"s\">\"2.1\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;persistence-unit</span> <span class=\"na\">name=</span><span class=\"s\">\"app\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;properties&gt;</span>\n      <span class=\"nt\">&lt;property</span> <span class=\"na\">name=</span><span class=\"s\">\"hibernate.dialect\"</span> <span class=\"na\">value=</span><span class=\"s\">\"org.hibernate.dialect.DB2Dialect\"</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;property</span> <span class=\"na\">name=</span><span class=\"s\">\"hibernate.connection.driver_class\"</span> <span class=\"na\">value=</span><span class=\"s\">\"com.ibm.db2.jcc.DB2Driver\"</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;property</span> <span class=\"na\">name=</span><span class=\"s\">\"hibernate.connection.url\"</span> <span class=\"na\">value=</span><span class=\"s\">\"jdbc:db2://[url]:[port]/[DBNAME]\"</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;property</span> <span class=\"na\">name=</span><span class=\"s\">\"hibernate.connection.username\"</span> <span class=\"na\">value=</span><span class=\"s\">\"[user name]\"</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;property</span> <span class=\"na\">name=</span><span class=\"s\">\"hibernate.connection.password\"</span> <span class=\"na\">value=</span><span class=\"s\">\"[password]\"</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;property</span> <span class=\"na\">name=</span><span class=\"s\">\"hibernate.show_sql\"</span> <span class=\"na\">value=</span><span class=\"s\">\"true\"</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;/properties&gt;</span>\n  <span class=\"nt\">&lt;/persistence-unit&gt;</span>\n<span class=\"nt\">&lt;/persistence&gt;</span>\n</pre></div>\n</div>\n\n<p><strong>そのあと次のようなmainメソッドを作成&amp;実行したところ、Javaアプリケーションが終了しなくなりました(´・ω・｀)</strong> たとえばeclipseで「右クリック &gt; Run As &gt; Java Application」と選択し、mainメソッドを実行すると、通常であればその中身を順に実行したあと「terminated」という表示が出現します。しかしこの手順でmainメソッドを実行すると、mainメソッドの最終行までは行きついているようなのですが、いつまでたっても「terminated」という表示が出てきません。あるいは実行可能jarにまとめて、このmainメソッドを実行すると、このプロセスがいつまでたっても終了しません。<code>kill -9</code>などで強制終了をかけない限り、mainメソッドから抜け出せないという現象が発生します。</p>\n\n<div class=\"code-frame\" data-lang=\"java\">\n<div class=\"code-lang\"><span class=\"bold\">Main.java</span></div>\n<div class=\"highlight\"><pre><span class=\"kn\">import</span> <span class=\"nn\">javax.persistence.EntityManager</span><span class=\"o\">;</span>\n<span class=\"kn\">import</span> <span class=\"nn\">javax.persistence.EntityManagerFactory</span><span class=\"o\">;</span>\n<span class=\"kn\">import</span> <span class=\"nn\">javax.persistence.EntityTransaction</span><span class=\"o\">;</span>\n<span class=\"kn\">import</span> <span class=\"nn\">javax.persistence.Persistence</span><span class=\"o\">;</span>\n\n<span class=\"kd\">public</span> <span class=\"kd\">class</span> <span class=\"nc\">Main</span> <span class=\"o\">{</span>\n    <span class=\"kd\">public</span> <span class=\"kd\">static</span> <span class=\"kt\">void</span> <span class=\"nf\">main</span><span class=\"o\">(</span><span class=\"nc\">String</span><span class=\"o\">[]</span> <span class=\"n\">args</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n        <span class=\"nc\">EntityManagerFactory</span> <span class=\"n\">factory</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n        <span class=\"nc\">EntityManager</span> <span class=\"n\">manager</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n        <span class=\"nc\">EntityTransaction</span> <span class=\"n\">transaction</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n\n        <span class=\"k\">try</span> <span class=\"o\">{</span>\n            <span class=\"n\">factory</span> <span class=\"o\">=</span> <span class=\"nc\">Persistence</span><span class=\"o\">.</span><span class=\"na\">createEntityManagerFactory</span><span class=\"o\">(</span><span class=\"s\">\"app\"</span><span class=\"o\">);</span>\n            <span class=\"n\">manager</span> <span class=\"o\">=</span> <span class=\"n\">factory</span><span class=\"o\">.</span><span class=\"na\">createEntityManager</span><span class=\"o\">();</span>\n            <span class=\"n\">transaction</span> <span class=\"o\">=</span> <span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"na\">getTransaction</span><span class=\"o\">();</span>\n\n            <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"na\">begin</span><span class=\"o\">();</span>            \n            <span class=\"c1\">// DO SOMETHING: DBへの操作を実施する。</span>\n            <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"na\">commit</span><span class=\"o\">();</span>\n        <span class=\"o\">}</span> <span class=\"k\">catch</span> <span class=\"o\">(</span><span class=\"nc\">RuntimeException</span> <span class=\"n\">e</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">transaction</span> <span class=\"o\">!=</span> <span class=\"kc\">null</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"na\">isActive</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n                <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"na\">rollback</span><span class=\"o\">();</span>\n            <span class=\"o\">}</span>\n            <span class=\"k\">throw</span> <span class=\"n\">e</span><span class=\"o\">;</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<p><strong>さてこの「mainメソッドの最終行にまで行きついたにも関わらず、アプリケーションが終了しない」問題ですが、<code>EntityManagerFactory</code>を<code>close</code>することで解決することができました。</strong>たとえばmainメソッドを以下のように書き換えてやると、mainメソッドの終了とともにeclipseは「terminated」を表示し、実行可能jarはプロセスを完了するようになりました。</p>\n\n<div class=\"code-frame\" data-lang=\"java\">\n<div class=\"code-lang\"><span class=\"bold\">Main.java</span></div>\n<div class=\"highlight\"><pre><span class=\"kn\">import</span> <span class=\"nn\">javax.persistence.EntityManager</span><span class=\"o\">;</span>\n<span class=\"kn\">import</span> <span class=\"nn\">javax.persistence.EntityManagerFactory</span><span class=\"o\">;</span>\n<span class=\"kn\">import</span> <span class=\"nn\">javax.persistence.EntityTransaction</span><span class=\"o\">;</span>\n<span class=\"kn\">import</span> <span class=\"nn\">javax.persistence.Persistence</span><span class=\"o\">;</span>\n\n<span class=\"kd\">public</span> <span class=\"kd\">class</span> <span class=\"nc\">Main</span> <span class=\"o\">{</span>\n    <span class=\"kd\">public</span> <span class=\"kd\">static</span> <span class=\"kt\">void</span> <span class=\"nf\">main</span><span class=\"o\">(</span><span class=\"nc\">String</span><span class=\"o\">[]</span> <span class=\"n\">args</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n        <span class=\"nc\">EntityManagerFactory</span> <span class=\"n\">factory</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n        <span class=\"nc\">EntityManager</span> <span class=\"n\">manager</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n        <span class=\"nc\">EntityTransaction</span> <span class=\"n\">transaction</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n\n        <span class=\"k\">try</span> <span class=\"o\">{</span>\n            <span class=\"n\">factory</span> <span class=\"o\">=</span> <span class=\"nc\">Persistence</span><span class=\"o\">.</span><span class=\"na\">createEntityManagerFactory</span><span class=\"o\">(</span><span class=\"s\">\"app\"</span><span class=\"o\">);</span>\n            <span class=\"n\">manager</span> <span class=\"o\">=</span> <span class=\"n\">factory</span><span class=\"o\">.</span><span class=\"na\">createEntityManager</span><span class=\"o\">();</span>\n            <span class=\"n\">transaction</span> <span class=\"o\">=</span> <span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"na\">getTransaction</span><span class=\"o\">();</span>\n\n            <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"na\">begin</span><span class=\"o\">();</span>\n            <span class=\"c1\">// DO SOMETHING: DBへの操作を実施する。</span>\n            <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"na\">commit</span><span class=\"o\">();</span>\n        <span class=\"o\">}</span> <span class=\"k\">catch</span> <span class=\"o\">(</span><span class=\"nc\">RuntimeException</span> <span class=\"n\">e</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">transaction</span> <span class=\"o\">!=</span> <span class=\"kc\">null</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"na\">isActive</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n                <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"na\">rollback</span><span class=\"o\">();</span>\n            <span class=\"o\">}</span>\n            <span class=\"k\">throw</span> <span class=\"n\">e</span><span class=\"o\">;</span>\n        <span class=\"o\">}</span> <span class=\"k\">finally</span> <span class=\"o\">{</span>\n            <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">manager</span> <span class=\"o\">!=</span> <span class=\"kc\">null</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n                <span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"na\">close</span><span class=\"o\">();</span>\n            <span class=\"o\">}</span>\n            <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">factory</span> <span class=\"o\">!=</span> <span class=\"kc\">null</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n                <span class=\"n\">factory</span><span class=\"o\">.</span><span class=\"na\">close</span><span class=\"o\">();</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<p>要するに<code>EntityManagerFactory</code>のクローズ漏れが原因でした。<a href=\"https://docs.oracle.com/javaee/7/api/javax/persistence/EntityManagerFactory.html\" rel=\"nofollow noopener\" target=\"_blank\"><code>EntityManagerFactory</code>のJavaDoc</a>を見ると、次のように記述されています: \"When the application has finished using the entity manager factory, and/or at application shutdown, the application should close the entity manager factory.\"  JavaEEやSpringを利用する場合、<code>@Autowired</code>や<code>@Inject</code>などを利用し、インスタンスの生成をすべてフレームワークにお任せするのが基本ですが、上述の例のようにインスタンスのライフサイクルを自ら制御する場合、アプリケーションの終了とともに<code>EntityManagerFactory#close</code>を呼び出して、アプリケーションが完了することをJPAにも通知してやる必要があるようです(´・ω・｀)</p>\n","body":"前提として、Hibernateのversionは5.3.3。pom.xmlのdependenciesは次のようになります。\n\n```xml:pom.xml\n<!-- https://mvnrepository.com/artifact/org.hibernate/hibernate-core -->\n<dependency>\n  <groupId>org.hibernate</groupId>\n  <artifactId>hibernate-core</artifactId>\n  <version>5.3.3.Final</version>\n</dependency>\n<!-- https://mvnrepository.com/artifact/javax.xml.bind/jaxb-api -->\n<dependency>\n  <groupId>javax.xml.bind</groupId>\n  <artifactId>jaxb-api</artifactId>\n  <version>2.3.0</version>\n</dependency>\n```\n\nまず以下のような`META-INF\\persistence.xml`を準備します。dialectやdriverがDb2になっていますが、ここではRDBMSの種類は問題ではなく、たとえばMySQLやPostgresを選択しても同様の問題が発生する--はず。\n\n```xml:persistence.xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<persistence\n  xmlns=\"http://xmlns.jcp.org/xml/ns/persistence\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://xmlns.jcp.org/xml/ns/persistence\n                      http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd\"\n  version=\"2.1\">\n  <persistence-unit name=\"app\">\n    <properties>\n      <property name=\"hibernate.dialect\" value=\"org.hibernate.dialect.DB2Dialect\" />\n      <property name=\"hibernate.connection.driver_class\" value=\"com.ibm.db2.jcc.DB2Driver\" />\n      <property name=\"hibernate.connection.url\" value=\"jdbc:db2://[url]:[port]/[DBNAME]\" />\n      <property name=\"hibernate.connection.username\" value=\"[user name]\" />\n      <property name=\"hibernate.connection.password\" value=\"[password]\" />\n      <property name=\"hibernate.show_sql\" value=\"true\" />\n    </properties>\n  </persistence-unit>\n</persistence>\n```\n\n__そのあと次のようなmainメソッドを作成&実行したところ、Javaアプリケーションが終了しなくなりました(´・ω・｀)__ たとえばeclipseで「右クリック > Run As > Java Application」と選択し、mainメソッドを実行すると、通常であればその中身を順に実行したあと「terminated」という表示が出現します。しかしこの手順でmainメソッドを実行すると、mainメソッドの最終行までは行きついているようなのですが、いつまでたっても「terminated」という表示が出てきません。あるいは実行可能jarにまとめて、このmainメソッドを実行すると、このプロセスがいつまでたっても終了しません。`kill -9`などで強制終了をかけない限り、mainメソッドから抜け出せないという現象が発生します。\n\n```java:Main.java\nimport javax.persistence.EntityManager;\nimport javax.persistence.EntityManagerFactory;\nimport javax.persistence.EntityTransaction;\nimport javax.persistence.Persistence;\n\npublic class Main {\n    public static void main(String[] args) {\n        EntityManagerFactory factory = null;\n        EntityManager manager = null;\n        EntityTransaction transaction = null;\n        \n        try {\n            factory = Persistence.createEntityManagerFactory(\"app\");\n            manager = factory.createEntityManager();\n            transaction = manager.getTransaction();\n            \n            transaction.begin();            \n            // DO SOMETHING: DBへの操作を実施する。\n            transaction.commit();\n        } catch (RuntimeException e) {\n            if (transaction != null && transaction.isActive()) {\n                transaction.rollback();\n            }\n            throw e;\n        }\n    }\n}\n```\n\n__さてこの「mainメソッドの最終行にまで行きついたにも関わらず、アプリケーションが終了しない」問題ですが、`EntityManagerFactory`を`close`することで解決することができました。__たとえばmainメソッドを以下のように書き換えてやると、mainメソッドの終了とともにeclipseは「terminated」を表示し、実行可能jarはプロセスを完了するようになりました。\n\n```java:Main.java\nimport javax.persistence.EntityManager;\nimport javax.persistence.EntityManagerFactory;\nimport javax.persistence.EntityTransaction;\nimport javax.persistence.Persistence;\n\npublic class Main {\n    public static void main(String[] args) {\n        EntityManagerFactory factory = null;\n        EntityManager manager = null;\n        EntityTransaction transaction = null;\n        \n        try {\n            factory = Persistence.createEntityManagerFactory(\"app\");\n            manager = factory.createEntityManager();\n            transaction = manager.getTransaction();\n            \n            transaction.begin();\n            // DO SOMETHING: DBへの操作を実施する。\n            transaction.commit();\n        } catch (RuntimeException e) {\n            if (transaction != null && transaction.isActive()) {\n                transaction.rollback();\n            }\n            throw e;\n        } finally {\n            if (manager != null) {\n                manager.close();\n            }\n            if (factory != null) {\n                factory.close();\n            }\n        }\n    }\n}\n```\n\n要するに`EntityManagerFactory`のクローズ漏れが原因でした。[`EntityManagerFactory`のJavaDoc](https://docs.oracle.com/javaee/7/api/javax/persistence/EntityManagerFactory.html)を見ると、次のように記述されています: \"When the application has finished using the entity manager factory, and/or at application shutdown, the application should close the entity manager factory.\"  JavaEEやSpringを利用する場合、`@Autowired`や`@Inject`などを利用し、インスタンスの生成をすべてフレームワークにお任せするのが基本ですが、上述の例のようにインスタンスのライフサイクルを自ら制御する場合、アプリケーションの終了とともに`EntityManagerFactory#close`を呼び出して、アプリケーションが完了することをJPAにも通知してやる必要があるようです(´・ω・｀)\n\n","coediting":false,"comments_count":0,"created_at":"2018-07-23T22:45:20+09:00","group":null,"id":"16255e7f36a6b355121d","likes_count":1,"private":false,"reactions_count":0,"tags":[{"name":"Java","versions":[]}],"title":"JPA(Hibernate)の利用時にmainメソッドの最終行まで行きついても、Javaアプリケーションが終了しない。","updated_at":"2018-07-23T22:49:29+09:00","url":"https://qiita.com/neko_the_shadow/items/16255e7f36a6b355121d","user":{"description":"IT業界の片隅でひっそり生きるシステムエンジニアです(´・ω・｀)","facebook_id":"","followees_count":0,"followers_count":33,"github_login_name":null,"id":"neko_the_shadow","items_count":168,"linkedin_id":"","location":"神奈川県川崎市","name":"","organization":"","permanent_id":105859,"profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/105859/profile-images/1473709753","team_only":false,"twitter_screen_name":"neko_the_shadow","website_url":"https://nekotheshadow.github.io/"},"page_views_count":null}