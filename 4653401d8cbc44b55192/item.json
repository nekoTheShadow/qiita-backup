{"rendered_body":"\n<h1>\n<span id=\"tldr\" class=\"fragment\"></span><a href=\"#tldr\"><i class=\"fa fa-link\"></i></a>TL;DR</h1>\n\n<p>MySQL8で、INSERT SELECTでWITHを利用したい場合、以下のように書けばよいです。</p>\n\n<div class=\"code-frame\" data-lang=\"SQL\"><div class=\"highlight\"><pre><code><span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">a</span> <span class=\"p\">(</span>\n  <span class=\"k\">WITH</span> <span class=\"k\">c</span> <span class=\"k\">AS</span> <span class=\"p\">(</span>\n    <span class=\"k\">SELECT</span> <span class=\"o\">*</span> <span class=\"k\">FROM</span> <span class=\"n\">b</span>\n  <span class=\"p\">)</span>\n  <span class=\"k\">SELECT</span> <span class=\"o\">*</span> <span class=\"k\">FROM</span> <span class=\"k\">c</span>\n<span class=\"p\">);</span>\n</code></pre></div></div>\n\n<p>WITH RECURSIVE (再帰SQL) も利用することができます。</p>\n\n<div class=\"code-frame\" data-lang=\"SQL\"><div class=\"highlight\"><pre><code><span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">e</span> <span class=\"p\">(</span>\n  <span class=\"k\">WITH</span> <span class=\"k\">RECURSIVE</span> <span class=\"n\">r</span> <span class=\"k\">AS</span> <span class=\"p\">(</span>\n    <span class=\"k\">SELECT</span> <span class=\"mi\">1</span> <span class=\"k\">AS</span> <span class=\"n\">seq</span>\n    <span class=\"k\">UNION</span> <span class=\"k\">ALL</span>\n    <span class=\"k\">SELECT</span> <span class=\"n\">seq</span> <span class=\"o\">+</span> <span class=\"mi\">1</span> <span class=\"k\">FROM</span> <span class=\"n\">r</span> <span class=\"k\">WHERE</span> <span class=\"n\">seq</span> <span class=\"o\">&lt;</span> <span class=\"mi\">5</span>\n  <span class=\"p\">)</span>\n  <span class=\"k\">SELECT</span> <span class=\"o\">*</span> <span class=\"k\">FROM</span> <span class=\"n\">r</span>\n<span class=\"p\">);</span>\n</code></pre></div></div>\n\n<h1>\n<span id=\"環境\" class=\"fragment\"></span><a href=\"#%E7%92%B0%E5%A2%83\"><i class=\"fa fa-link\"></i></a>環境</h1>\n\n<p>mysql  Ver 8.0.23 for Linux on x86_64 (MySQL Community Server - GPL)</p>\n\n<h1>\n<span id=\"稼働確認用ddl\" class=\"fragment\"></span><a href=\"#%E7%A8%BC%E5%83%8D%E7%A2%BA%E8%AA%8D%E7%94%A8ddl\"><i class=\"fa fa-link\"></i></a>稼働確認用DDL</h1>\n\n<h2>\n<span id=\"with\" class=\"fragment\"></span><a href=\"#with\"><i class=\"fa fa-link\"></i></a>WITH</h2>\n\n<div class=\"code-frame\" data-lang=\"SQL\"><div class=\"highlight\"><pre><code><span class=\"k\">CREATE</span> <span class=\"k\">TABLE</span> <span class=\"n\">a</span> <span class=\"p\">(</span>\n  <span class=\"n\">col</span> <span class=\"nb\">text</span>\n<span class=\"p\">);</span>\n<span class=\"k\">CREATE</span> <span class=\"k\">TABLE</span> <span class=\"n\">b</span> <span class=\"p\">(</span>\n  <span class=\"n\">col</span> <span class=\"nb\">text</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">b</span> <span class=\"k\">VALUES</span> <span class=\"p\">(</span><span class=\"s1\">'col1'</span><span class=\"p\">);</span>\n<span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">b</span> <span class=\"k\">VALUES</span> <span class=\"p\">(</span><span class=\"s1\">'col2'</span><span class=\"p\">);</span>\n<span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">b</span> <span class=\"k\">VALUES</span> <span class=\"p\">(</span><span class=\"s1\">'col3'</span><span class=\"p\">);</span>\n<span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">b</span> <span class=\"k\">VALUES</span> <span class=\"p\">(</span><span class=\"s1\">'col4'</span><span class=\"p\">);</span>\n<span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">b</span> <span class=\"k\">VALUES</span> <span class=\"p\">(</span><span class=\"s1\">'col5'</span><span class=\"p\">);</span>\n\n<span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">a</span> <span class=\"p\">(</span>\n  <span class=\"k\">WITH</span> <span class=\"k\">c</span> <span class=\"k\">AS</span> <span class=\"p\">(</span>\n    <span class=\"k\">SELECT</span> <span class=\"o\">*</span> <span class=\"k\">FROM</span> <span class=\"n\">b</span>\n  <span class=\"p\">)</span>\n  <span class=\"k\">SELECT</span> <span class=\"o\">*</span> <span class=\"k\">FROM</span> <span class=\"k\">c</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">SELECT</span> <span class=\"o\">*</span> <span class=\"k\">FROM</span> <span class=\"n\">a</span><span class=\"p\">;</span>\n</code></pre></div></div>\n\n<p>このSQLが以下のような結果セットを返すことを確認する。</p>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left\">col</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: left\">col1</td>\n</tr>\n<tr>\n<td style=\"text-align: left\">col2</td>\n</tr>\n<tr>\n<td style=\"text-align: left\">col3</td>\n</tr>\n<tr>\n<td style=\"text-align: left\">col4</td>\n</tr>\n<tr>\n<td style=\"text-align: left\">col5</td>\n</tr>\n</tbody>\n</table>\n\n<h2>\n<span id=\"with-recursive\" class=\"fragment\"></span><a href=\"#with-recursive\"><i class=\"fa fa-link\"></i></a>WITH RECURSIVE</h2>\n\n<div class=\"code-frame\" data-lang=\"SQL\"><div class=\"highlight\"><pre><code><span class=\"k\">CREATE</span> <span class=\"k\">TABLE</span> <span class=\"n\">e</span> <span class=\"p\">(</span>\n  <span class=\"n\">seq</span> <span class=\"nb\">INT</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">INSERT</span> <span class=\"k\">INTO</span> <span class=\"n\">e</span> <span class=\"p\">(</span>\n  <span class=\"k\">WITH</span> <span class=\"k\">RECURSIVE</span> <span class=\"n\">r</span> <span class=\"k\">AS</span> <span class=\"p\">(</span>\n    <span class=\"k\">SELECT</span> <span class=\"mi\">1</span> <span class=\"k\">AS</span> <span class=\"n\">seq</span>\n    <span class=\"k\">UNION</span> <span class=\"k\">ALL</span>\n    <span class=\"k\">SELECT</span> <span class=\"n\">seq</span> <span class=\"o\">+</span> <span class=\"mi\">1</span> <span class=\"k\">FROM</span> <span class=\"n\">r</span> <span class=\"k\">WHERE</span> <span class=\"n\">seq</span> <span class=\"o\">&lt;</span> <span class=\"mi\">5</span>\n  <span class=\"p\">)</span>\n  <span class=\"k\">SELECT</span> <span class=\"o\">*</span> <span class=\"k\">FROM</span> <span class=\"n\">r</span>\n<span class=\"p\">);</span>\n\n<span class=\"k\">SELECT</span> <span class=\"o\">*</span> <span class=\"k\">FROM</span> <span class=\"n\">e</span><span class=\"p\">;</span>\n</code></pre></div></div>\n\n<p>このSQLが以下のような結果セットを返すことを確認する。</p>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: right\">seq</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: right\">1</td>\n</tr>\n<tr>\n<td style=\"text-align: right\">2</td>\n</tr>\n<tr>\n<td style=\"text-align: right\">3</td>\n</tr>\n<tr>\n<td style=\"text-align: right\">4</td>\n</tr>\n<tr>\n<td style=\"text-align: right\">5</td>\n</tr>\n</tbody>\n</table>\n","body":"# TL;DR\n\nMySQL8で、INSERT SELECTでWITHを利用したい場合、以下のように書けばよいです。\n\n```SQL\nINSERT INTO a (\n  WITH c AS (\n    SELECT * FROM b\n  )\n  SELECT * FROM c\n);\n```\n\nWITH RECURSIVE (再帰SQL) も利用することができます。\n\n```SQL\nINSERT INTO e (\n  WITH RECURSIVE r AS (\n    SELECT 1 AS seq\n    UNION ALL\n    SELECT seq + 1 FROM r WHERE seq < 5\n  )\n  SELECT * FROM r\n);\n```\n\n\n# 環境\n\nmysql  Ver 8.0.23 for Linux on x86_64 (MySQL Community Server - GPL)\n\n# 稼働確認用DDL\n\n## WITH\n\n```SQL\nCREATE TABLE a (\n  col text\n);\nCREATE TABLE b (\n  col text\n);\n\nINSERT INTO b VALUES ('col1');\nINSERT INTO b VALUES ('col2');\nINSERT INTO b VALUES ('col3');\nINSERT INTO b VALUES ('col4');\nINSERT INTO b VALUES ('col5');\n\nINSERT INTO a (\n  WITH c AS (\n    SELECT * FROM b\n  )\n  SELECT * FROM c\n);\n\nSELECT * FROM a;\n```\n\nこのSQLが以下のような結果セットを返すことを確認する。\n\n|col|\n|:---|\n|col1|\n|col2|\n|col3|\n|col4|\n|col5|\n\n## WITH RECURSIVE\n\n```SQL\nCREATE TABLE e (\n  seq INT\n);\n\nINSERT INTO e (\n  WITH RECURSIVE r AS (\n    SELECT 1 AS seq\n    UNION ALL\n    SELECT seq + 1 FROM r WHERE seq < 5\n  )\n  SELECT * FROM r\n);\n\nSELECT * FROM e;\n```\n\nこのSQLが以下のような結果セットを返すことを確認する。\n\n|seq|\n|---:|\n|1|\n|2|\n|3|\n|4|\n|5|\n","coediting":false,"comments_count":0,"created_at":"2021-03-02T10:51:40+09:00","group":null,"id":"4653401d8cbc44b55192","likes_count":1,"private":false,"reactions_count":0,"tags":[{"name":"MySQL","versions":[]},{"name":"SQL","versions":[]}],"title":"INSERT SELECTでWITHを利用したい","updated_at":"2021-03-24T23:17:30+09:00","url":"https://qiita.com/neko_the_shadow/items/4653401d8cbc44b55192","user":{"description":"IT業界の片隅でひっそり生きるシステムエンジニアです(´・ω・｀)","facebook_id":"","followees_count":0,"followers_count":36,"github_login_name":null,"id":"neko_the_shadow","items_count":194,"linkedin_id":"","location":"神奈川県川崎市","name":"","organization":"","permanent_id":105859,"profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/105859/profile-images/1473709753","team_only":false,"twitter_screen_name":"neko_the_shadow","website_url":"https://nekotheshadow.github.io/"},"page_views_count":null,"team_membership":null}